# doppler
Personal website for eric rodefeld.

## Local Development

### Prerequisites
- Docker & Docker Compose
- Go 1.25.4+
- Bun (for JavaScript bundling)

### Quick Start

1. **Copy environment file**
   ```bash
   cp example.env .env
   ```

2. **Start all services with Docker Compose**
   ```bash
   docker compose up
   ```

   This will:
   - Start **Garage** (S3-compatible object storage) on port 3900
   - Run **garage-init** to automatically bootstrap Garage (create bucket, generate keys)
   - Start the **web** app with hot-reloading on port 1323
   - Create SQLite database at `data/doppler.db` with automatic migrations

3. **Access the application**
   - App: http://localhost:1323

### What's Included

**Services:**
- `web` - Go web app with hot-reloading (air), templ templates, and Tailwind CSS
- `garage` - S3-compatible object storage (Garage v2.1.0)
- `garage-init` - One-time setup service that configures Garage automatically

**Storage:**
- SQLite database: `data/doppler.db` (persisted in Docker volume)
- S3 bucket: `doppler-photos` (persisted in Docker volume)
- S3 keys: Dynamically generated by `garage-init`

### Development Workflow

The `docker compose up` command automatically:
1. Builds the dev container with Go tools (air, templ, bun)
2. Watches for file changes and rebuilds automatically
3. Runs `templ generate`, `bun run build:js`, and `bun run build:css` before each build
4. Hot-reloads the Go application

**What gets auto-built:**
- Templ templates → `*_templ.go` files
- JavaScript bundle → `static/dist/index.js` (HTMX, Quill, tsParticles)
- Tailwind CSS → `static/css/output.css`

### Finding S3 Credentials

S3 access keys are generated dynamically. To retrieve them:

```bash
# List all keys
docker compose exec garage /garage -c /etc/garage.toml key list

# Get key details (including secret)
docker compose exec garage /garage -c /etc/garage.toml key info doppler-dev
```

### Manual Development (without Docker)

If you prefer to run outside Docker:

1. **Install dependencies**
   ```bash
   go mod download
   bun install
   ```

2. **Set up environment**
   ```bash
   cp example.env .env
   # Edit .env - you'll need to run Garage separately or use a different S3 service
   ```

3. **Run in separate terminals**
   
   Terminal 1 - Hot reload:
   ```bash
   air
   ```
   
   Terminal 2 - Watch templ templates:
   ```bash
   templ generate --watch
   ```
   
   Terminal 3 - Watch Tailwind CSS:
   ```bash
   bun run dev:js
   npx tailwindcss -i ./static/css/input.css -o ./static/css/output.css --watch
   ```

## Production Deployment

### Build and Push Production Image

```bash
cd /home/prometheus/universe/doppler

# Build production image (generates templ, bundles JS, compiles Go)


# Push to registry
docker push edrodefeld/doppler
```

**Production Build Process:**
1. Installs templ and bun in builder stage
2. Generates templ templates from `.templ` files
3. Bundles JavaScript (HTMX, Quill, tsParticles) into `static/dist/index.js`
4. Compiles Tailwind CSS to `static/css/output.css`
5. Builds Go binary with CGO enabled (for SQLite)
6. Creates slim Debian image with binary and static assets

The Dockerfile defaults to a production build (slim Debian image with compiled binary).

### Deploy to Kubernetes

**Initial deployment:**
```bash
kubectl apply -f ../mirage/deployments/doppler.yml
```

**Update deployment (after pushing new image):**
```bash
kubectl rollout restart deployment/doppler -n galaxy
```

The deployment uses `imagePullPolicy: Always` to ensure fresh images are pulled on every rollout.

**Production Configuration:**
- Uses Garage S3 at `http://garage-s3.galaxy.svc.cluster.local:3900`
- S3 credentials stored in Kubernetes secret `doppler-s3-secrets`
- SQLite database persisted on PVC `doppler-volume-claim`
- Database path: `data/doppler.db` (automatically creates directory)


## Environment Variables

See `example.env` for all available options:

- `DB_PATH` - SQLite database path (default: `data/doppler.db`)
- `S3_ENDPOINT` - Internal S3 endpoint (e.g., `http://garage:3900`)
- `S3_REGION` - S3 region (e.g., `garage`)
- `S3_BUCKET` - S3 bucket for images (e.g., `doppler-photos`)
- `S3_USE_SSL` - Use SSL for S3 (set to `false` for internal HTTP)
- `S3_ACCESS_KEY_ID` - S3 access key (auto-generated by garage-init)
- `S3_SECRET_ACCESS_KEY` - S3 secret key (auto-generated by garage-init)
- `GARAGE_RPC_SECRET` - Garage cluster secret (for Docker Compose only)

## Troubleshooting

**Clean up and restart:**
```bash
docker compose down
docker compose up --build
```

**View Garage status:**
```bash
docker compose exec garage /garage -c /etc/garage.toml status
```

**View logs:**
```bash
docker compose logs -f web
docker compose logs -f garage
```
