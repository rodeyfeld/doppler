# doppler
Personal website for rodeyfeld.

## Local Development

### Prerequisites
- Docker & Docker Compose
- Go 1.23+
- Bun (for JavaScript bundling)

### Quick Start

1. **Copy environment file**
   ```bash
   cp example.env .env
   ```

2. **Start all services with Docker Compose**
   ```bash
   docker compose up
   ```

   This will:
   - Start **Garage** (S3-compatible object storage) on port 3900
   - Run **garage-init** to automatically bootstrap Garage (create bucket, generate keys)
   - Start the **web** app with hot-reloading on port 1323
   - Create SQLite database at `data/doppler.db` with automatic migrations

3. **Access the application**
   - App: http://localhost:1323
   - Garage Admin UI: http://localhost:3902

### What's Included

**Services:**
- `web` - Go web app with hot-reloading (air), templ templates, and Tailwind CSS
- `garage` - S3-compatible object storage (Garage v2.1.0)
- `garage-init` - One-time setup service that configures Garage automatically

**Storage:**
- SQLite database: `data/doppler.db` (persisted in Docker volume)
- S3 bucket: `doppler-photos` (persisted in Docker volume)
- S3 keys: Dynamically generated by `garage-init`

### Development Workflow

The `docker compose up` command automatically:
1. Builds the dev container with Go tools (air, templ)
2. Watches for file changes and rebuilds automatically
3. Runs `templ generate` and `bun run build:js` before each build
4. Hot-reloads the Go application

Just edit your files and the app will rebuild automatically!

### Finding S3 Credentials

S3 access keys are generated dynamically. To retrieve them:

```bash
# List all keys
docker compose exec garage /garage -c /etc/garage.toml key list

# Get key details (including secret)
docker compose exec garage /garage -c /etc/garage.toml key info doppler-dev
```

### Manual Development (without Docker)

If you prefer to run outside Docker:

1. **Install dependencies**
   ```bash
   go mod download
   bun install
   ```

2. **Set up environment**
   ```bash
   cp example.env .env
   # Edit .env - you'll need to run Garage separately or use a different S3 service
   ```

3. **Run in separate terminals**
   
   Terminal 1 - Hot reload:
   ```bash
   air
   ```
   
   Terminal 2 - Watch templ templates:
   ```bash
   templ generate --watch
   ```
   
   Terminal 3 - Watch Tailwind CSS:
   ```bash
   bun run dev:js
   npx tailwindcss -i ./static/css/input.css -o ./static/css/output.css --watch
   ```

## Production Deployment

### Build Production Image

```bash
docker build -t edrodefeld/doppler:latest .
docker push edrodefeld/doppler:latest
```

The Dockerfile defaults to a production build (slim Debian image with compiled binary).

### Deploy to Kubernetes

```bash
kubectl apply -f ../mirage/deployments/doppler.yml
```

**Production Configuration:**
- Uses Garage S3 at `http://garage-s3.galaxy.svc.cluster.local:3900`
- S3 credentials stored in Kubernetes secret `doppler-s3-secrets`
- SQLite database persisted on PVC `doppler-volume-claim`
- Database path: `data/doppler.db` (automatically creates directory)

## Project Structure

```
doppler/
├── cmd/
│   ├── main.go              # Application entry point
│   └── garageinit/          # Garage bootstrap utility
├── internal/
│   ├── components/          # Templ components
│   ├── db/                  # Database connection & migrations
│   ├── models/              # Data models
│   ├── server/              # HTTP server setup
│   └── services/            # Business logic
├── static/                  # CSS, JS, images
├── compose.yml              # Docker Compose for local dev
├── Dockerfile               # Multi-stage build (dev + production)
├── garage-init.Dockerfile   # Garage bootstrap container
└── garage.toml              # Garage configuration
```

## Environment Variables

See `example.env` for all available options:

- `DB_PATH` - SQLite database path (default: `data/doppler.db`)
- `GARAGE_RPC_SECRET` - Garage cluster secret (for Docker Compose only)
- S3 variables are commented out - they'll be needed when S3 features are implemented

## Troubleshooting

**Clean up and restart:**
```bash
docker compose down
docker compose up --build
```

**View Garage status:**
```bash
docker compose exec garage /garage -c /etc/garage.toml status
```

**View logs:**
```bash
docker compose logs -f web
docker compose logs -f garage
```
